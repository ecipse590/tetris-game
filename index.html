<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Tetris Game</title>
  <style>
    body {
      background: #111;
      color: white;
      font-family: Arial, sans-serif;
      display: flex;
      justify-content: center;
      gap: 30px;
      padding: 20px;
    }

    canvas {
      background: black;
      border: 2px solid #555;
    }

    .panel {
      width: 250px;
    }

    h2 {
      text-align: center;
    }

    ul {
      list-style: none;
      padding: 0;
    }

    .leaderboard-item {
      display: flex;
      justify-content: space-between;
      padding: 6px;
      border-bottom: 1px solid #333;
    }

    .gold { color: gold; }
    .silver { color: silver; }
    .bronze { color: #cd7f32; }
  </style>
</head>
<body>

<canvas id="game" width="240" height="400"></canvas>

<div class="panel">
  <h2>Leaderboard</h2>
  <ul id="leaderboard"></ul>
</div>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<script>
  // ðŸ”¥ Firebase config (YOUR PROJECT)
  const firebaseConfig = {
    apiKey: "AIzaSyDj62d9B9d_f6EvnE43kM4Ga2EOY5AlH0I",
    authDomain: "tetris-leaderboard-e8761.firebaseapp.com",
    projectId: "tetris-leaderboard-e8761",
    storageBucket: "tetris-leaderboard-e8761.firebasestorage.app",
    messagingSenderId: "25156481672",
    appId: "1:25156481672:web:bdb2ab27f0ed196b31253d"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
</script>

<script>
/* =========================
   TETRIS GAME
========================= */

const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
const leaderboardList = document.getElementById("leaderboard");

const COLS = 10;
const ROWS = 20;
const BLOCK = 20;

ctx.scale(BLOCK, BLOCK);

const COLORS = [null, "cyan", "blue", "orange", "yellow", "green", "purple", "red"];

const SHAPES = [
  [],
  [[1,1,1,1]],
  [[2,0,0],[2,2,2]],
  [[0,0,3],[3,3,3]],
  [[4,4],[4,4]],
  [[0,5,5],[5,5,0]],
  [[0,6,0],[6,6,6]],
  [[7,7,0],[0,7,7]]
];

let board = createMatrix(COLS, ROWS);
let score = 0;

const player = {
  pos: {x: 0, y: 0},
  matrix: null
};

function createMatrix(w, h) {
  const m = [];
  while (h--) m.push(new Array(w).fill(0));
  return m;
}

function collide(board, player) {
  const m = player.matrix;
  const o = player.pos;
  for (let y = 0; y < m.length; y++) {
    for (let x = 0; x < m[y].length; x++) {
      if (m[y][x] !== 0 &&
         (board[y + o.y] &&
          board[y + o.y][x + o.x]) !== 0) {
        return true;
      }
    }
  }
  return false;
}

function merge(board, player) {
  player.matrix.forEach((row, y) => {
    row.forEach((value, x) => {
      if (value !== 0) {
        board[y + player.pos.y][x + player.pos.x] = value;
      }
    });
  });
}

function rotate(matrix) {
  return matrix[0].map((_, i) =>
    matrix.map(row => row[i]).reverse()
  );
}

function drawMatrix(matrix, offset) {
  matrix.forEach((row, y) => {
    row.forEach((value, x) => {
      if (value !== 0) {
        ctx.fillStyle = COLORS[value];
        ctx.fillRect(x + offset.x, y + offset.y, 1, 1);
      }
    });
  });
}

function draw() {
  ctx.fillStyle = "#000";
  ctx.fillRect(0, 0, canvas.width, canvas.height);
  drawMatrix(board, {x: 0, y: 0});
  drawMatrix(player.matrix, player.pos);
}

function playerDrop() {
  player.pos.y++;
  if (collide(board, player)) {
    player.pos.y--;
    merge(board, player);
    resetPlayer();
    sweep();
  }
}

function sweep() {
  outer: for (let y = board.length - 1; y >= 0; y--) {
    for (let x = 0; x < board[y].length; x++) {
      if (board[y][x] === 0) continue outer;
    }
    board.splice(y, 1);
    board.unshift(new Array(COLS).fill(0));
    score += 100;
  }
}

function resetPlayer() {
  player.matrix = SHAPES[Math.floor(Math.random() * (SHAPES.length - 1)) + 1];
  player.pos.y = 0;
  player.pos.x = (COLS / 2 | 0) - (player.matrix[0].length / 2 | 0);

  if (collide(board, player)) {
    const name = prompt("Game Over! Enter your name:");
    if (name && window.db) addScore(name, score);
    board = createMatrix(COLS, ROWS);
    score = 0;
  }
}

document.addEventListener("keydown", e => {
  if (e.key === "ArrowLeft") player.pos.x--;
  if (e.key === "ArrowRight") player.pos.x++;
  if (e.key === "ArrowDown") playerDrop();
  if (e.key === "ArrowUp") {
    const rotated = rotate(player.matrix);
    const old = player.matrix;
    player.matrix = rotated;
    if (collide(board, player)) player.matrix = old;
  }
});

let dropCounter = 0;
let lastTime = 0;

function update(time = 0) {
  const delta = time - lastTime;
  lastTime = time;
  dropCounter += delta;
  if (dropCounter > 1000) {
    playerDrop();
    dropCounter = 0;
  }
  draw();
  requestAnimationFrame(update);
}

/* =========================
   GLOBAL LEADERBOARD
========================= */

async function addScore(name, score) {
  try {
    await db.collection("leaderboard").add({
      name: name.substring(0, 15),
      score,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    renderLeaderboard();
  } catch {}
}

async function renderLeaderboard() {
  leaderboardList.innerHTML = "<li>Loading...</li>";
  try {
    const snap = await db.collection("leaderboard")
      .orderBy("score", "desc")
      .limit(10)
      .get();

    leaderboardList.innerHTML = "";

    snap.forEach((doc, i) => {
      const d = doc.data();
      const li = document.createElement("li");
      li.className = "leaderboard-item";
      li.innerHTML = `<span>#${i+1} ${d.name}</span><span>${d.score}</span>`;
      leaderboardList.appendChild(li);
    });
  } catch {
    leaderboardList.innerHTML = "<li>Leaderboard offline</li>";
  }
}

/* =========================
   START GAME
========================= */

resetPlayer();
update();
renderLeaderboard();
</script>

</body>
</html>
